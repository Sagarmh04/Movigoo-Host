rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is owner (movigoo4@gmail.com)
    function isOwner() {
      return request.auth != null && request.auth.token.email == 'movigoo4@gmail.com';
    }
    
    // Check if user is support staff
    function isSupport() {
      return request.auth != null && 
             (request.auth.token.email == 'movigootech@gmail.com' || 
              request.auth.token.email == 'movigoo4@gmail.com');
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: Check if event belongs to organizer
    function isEventOwner(eventId) {
      return exists(/databases/$(database)/documents/events/$(eventId)) &&
             (get(/databases/$(database)/documents/events/$(eventId)).data.hostUserId == request.auth.uid ||
              get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == request.auth.uid);
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    // Path: users/{userId}
    // Purpose: User profile information
    match /users/{userId} {
      // Read: Users can read their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Write: Users can update their own profile
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // EVENTS COLLECTION
    // ============================================
    // Path: events/{eventId}
    // Purpose: Event listings created by organizers
    match /events/{eventId} {
      // Read: Organizers can read their own events, owner can read all
      allow read: if isAuthenticated() && (
        resource.data.hostUserId == request.auth.uid ||
        resource.data.organizerId == request.auth.uid ||
        isOwner()
      );
      
      // Create: Authenticated users can create events (backend sets hostUserId)
      allow create: if isAuthenticated();
      
      // Update: Organizers can update their own events
      // Owner can update payout fields (manualPayoutPaid, manualPayoutNote, manualPayoutPaidAt, updatedAt)
      allow update: if isAuthenticated() && (
        // Organizer can update their own events
        (resource.data.hostUserId == request.auth.uid || 
         resource.data.organizerId == request.auth.uid) ||
        // Owner can update payout fields only
        (isOwner() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly([
           'manualPayoutPaid', 
           'manualPayoutNote', 
           'manualPayoutPaidAt', 
           'updatedAt'
         ]))
      );
      
      // Delete: Organizers can delete their own events
      allow delete: if isAuthenticated() && (
        resource.data.hostUserId == request.auth.uid ||
        resource.data.organizerId == request.auth.uid
      );
      
      // ============================================
      // BOOKINGS SUBCOLLECTION
      // ============================================
      // Path: events/{eventId}/bookings/{bookingId}
      // Purpose: Ticket bookings for events
      match /bookings/{bookingId} {
        // Read: Organizers can read bookings for their events, owner can read all
        allow read: if isAuthenticated() && (
          isEventOwner(eventId) ||
          isOwner()
        );
        
        // Create: Authenticated users (bookings created by backend/API)
        allow create: if isAuthenticated();
        
        // Update: Organizers can update bookings for their events, owner can update any
        allow update: if isAuthenticated() && (
          isEventOwner(eventId) ||
          isOwner()
        );
        
        // Delete: Only owner can delete bookings (or backend)
        allow delete: if isOwner();
      }
    }
    
    // ============================================
    // ORGANIZERS COLLECTION
    // ============================================
    // Path: organizers/{organizerId}
    // Purpose: Organizer profiles with bank details and KYC status
    match /organizers/{organizerId} {
      // Read: Organizers can read their own document, owner can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == organizerId ||
        isOwner()
      );
      
      // Write: Organizers can update their own document (e.g., bank details, KYC)
      allow write: if isAuthenticated() && request.auth.uid == organizerId;
      
      // Note: accountNumberFull field should be filtered on client-side for non-owner users
    }
    
    // ============================================
    // SUPPORT TICKETS COLLECTION
    // ============================================
    // Path: supportTickets/{ticketId}
    // Purpose: Customer support tickets
    match /supportTickets/{ticketId} {
      // Read: Users can read their own tickets, support staff can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isSupport()
      );
      
      // Create: Authenticated users can create tickets (userId must match auth.uid)
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
      
      // Update: Only support staff can update tickets
      allow update: if isAuthenticated() && isSupport();
      
      // Delete: Only support staff can delete tickets
      allow delete: if isAuthenticated() && isSupport();
      
      // ============================================
      // SUPPORT TICKET MESSAGES SUBCOLLECTION
      // ============================================
      // Path: supportTickets/{ticketId}/messages/{messageId}
      // Purpose: Messages/replies in support tickets
      match /messages/{messageId} {
        // Read: Users can read messages for their own tickets, support can read all
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId == request.auth.uid ||
          isSupport()
        );
        
        // Create: Users can reply to their own tickets, support can reply to any
        allow create: if isAuthenticated() && (
          get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId == request.auth.uid ||
          isSupport()
        );
        
        // Update/Delete: Only support staff can modify messages
        allow update, delete: if isAuthenticated() && isSupport();
      }
    }
    
    // ============================================
    // VOLUNTEERS COLLECTION
    // ============================================
    // Path: volunteers/{volunteerId}
    // Purpose: Volunteer accounts created by organizers
    match /volunteers/{volunteerId} {
      // Read: Organizers can read volunteers they created
      allow read: if isAuthenticated() && 
                  resource.data.hostUserId == request.auth.uid;
      
      // Create: Organizers can create volunteers (hostUserId must match auth.uid)
      allow create: if isAuthenticated() && 
                    request.resource.data.hostUserId == request.auth.uid;
      
      // Update: Organizers can update volunteers they created
      allow update: if isAuthenticated() && 
                    resource.data.hostUserId == request.auth.uid;
      
      // Delete: Organizers can delete volunteers they created
      allow delete: if isAuthenticated() && 
                    resource.data.hostUserId == request.auth.uid;
    }
    
    // ============================================
    // HOST ANALYTICS COLLECTION
    // ============================================
    // Path: host_analytics/{hostId}
    // Purpose: Aggregated analytics for each organizer (read-only from client)
    match /host_analytics/{hostId} {
      // Read: Organizers can read their own analytics, owner can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == hostId ||
        isOwner()
      );
      
      // Write: Backend/Cloud Functions only (no client writes)
      allow write: if false;
    }
    
    // ============================================
    // EVENT ANALYTICS COLLECTION
    // ============================================
    // Path: event_analytics/{eventId}
    // Purpose: Per-event analytics (read-only from client)
    match /event_analytics/{eventId} {
      // Read: Organizers can read analytics for their own events, owner can read all
      allow read: if isAuthenticated() && (
        // Check if event belongs to organizer
        isEventOwner(eventId) ||
        // Owner can read all
        isOwner()
      );
      
      // Write: Backend/Cloud Functions only (no client writes)
      allow write: if false;
    }
    
    // ============================================
    // DEFAULT DENY (Security by default)
    // ============================================
    // All other collections/documents are denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
